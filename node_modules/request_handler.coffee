# :mode=coffeescript:indentSize=2:noTabs=true:tabSize=2:
# request handler registry

url=require 'url'

conf=require('module_conf').conf.modules.request_handler

handlers={}

get_handler=(name) ->
  throw new Error('Unknown request handler '+name) unless handlers[name]?
  return handlers[name]

default_handler=(req,res) ->
  res.writeHead 404,'Content-Type':'text/plain'
  res.end 'Unknown request '+req.url

exports.add=(pathname,handler) ->
  obj=require handler
  if not obj.handle?
    throw new Error('Request handler '+v+' has no handle() method')

  if handlers[pathname]?
    console.warn 'Overwriting request '+pathname+' with '+handler
  handlers[pathname]=obj.handle

exports.add_default=(handler) ->
  obj=require handler
  if not obj.handle?
    throw new Error('Request handler '+v+' has no handle() method')

  default_handler=obj.handle

exports.remove=(pathname) ->
  handlers[pathname]=null

exports.forward=(pathname,handler) ->
  handlers[pathname]=get_handler handler

for pathname,modname of conf.requests
  if pathname=='default'
    exports.add_default modname
  else
    exports.add pathname,modname

global.on_server_request (req,res) ->
  console.log 'Request: '+req.method+' '+req.url
  (handlers[(url.parse req.url).pathname] ? default_handler)(req,res)

