# request handler registry

url=require 'url'

response=require 'response_helpers'

conf=require('module_conf').conf.modules.request_handler

handlers={}

get_handler=(name) ->
  throw new Error('Unknown request handler '+name) unless handlers[name]?
  return handlers[name]

default_handler=(req,res) ->
  response.not_found req,res

exports.add=(pathname,handler) ->
  obj=require handler
  if not obj.handle?
    throw new Error('Request handler '+handler+' has no handle() method')

  if handlers[pathname]?
    console.warn 'Overwriting request '+pathname+' with '+handler
  handlers[pathname]=obj.handle

exports.add_default=(handler) ->
  obj=require handler
  if not obj.handle?
    throw new Error('Request handler '+handler+' has no handle() method')

  default_handler=obj.handle

exports.remove=(pathname) ->
  handlers[pathname]=null

if conf.default_request?
  exports.add_default conf.default_request

for pathname,modname of conf.requests
  exports.add pathname,modname

global.on_server_request (req,res) ->
  console.log 'Request: '+req.method+' '+req.url
  (handlers[(url.parse req.url).pathname] ? default_handler)(req,res)

