# :mode=coffeescript:indentSize=2:noTabs=true:tabSize=2:
# static file serving

fs=require 'fs'
path=require 'path'
url=require 'url'

error=require 'error_handling'
mime=require 'mime_types'

CONF_ROOT='modules.static_file_req'
STATIC_FILE_ROOT=conf(CONF_ROOT+'.root') ? path.join process.cwd(),'./static'

forwards={}

exports.forward=(srcpath,destpath) ->
  forwards[srcpath]=destpath

exports.handle=(req,res) ->
  pathname=(url.parse req.url).pathname
  file_path=path.join STATIC_FILE_ROOT,forwards[pathname] ? pathname
  path.exists file_path,(exists) ->
    if exists
      fs.readFile file_path,(err,data) ->
        unless err
          head=
            'Content-Type':mime.get_type_from_file file_path
          res.writeHead 200,head
          res.end data
        else
          error.fatal req,res,err
    else
      res.writeHead 404,'Content-Type':'text/plain'
      res.end 'Unknown file'

for srcpath,destpath of conf CONF_ROOT+'.forwards'
  exports.forward srcpath,destpath

