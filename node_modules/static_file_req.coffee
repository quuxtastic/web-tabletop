# static file serving

fs=require 'fs'
path=require 'path'
url=require 'url'

response=require 'response_helpers'
mime=require 'mime_types'

conf=require('module_conf').conf.modules.static_file_req

STATIC_FILE_ROOT=conf.root ? path.join process.cwd(),'./static'

forwards={}

exports.forward=(srcpath,destpath) ->
  forwards[srcpath]=destpath

exports.handle=(req,res) ->
  pathname=(url.parse req.url).pathname
  file_path=path.join STATIC_FILE_ROOT,forwards[pathname] ? pathname
  path.exists file_path,(exists) ->
    if exists
      fs.readFile file_path,(err,data) ->
        unless err
          res.writeHead 200,
            'Content-Type':mime.get_type_from_file file_path
          res.end data
        else
          response.error req,res,err
    else
      response.not_found req,res,file_path

for srcpath,destpath of conf.forwards
  exports.forward srcpath,destpath

